# LangChainå¯¹è¯æ¶ˆæ¯ç®¡ç†æœºåˆ¶

æœ¬æ–‡ä¸»è¦ä»‹ç»æˆ‘ä»¬åœ¨ä½¿ç”¨ `langgraph` è¿‡ç¨‹ä¸­ï¼Œç»å¸¸ä¼šå®šä¹‰ä¸€ä¸ªå‡½æ•°ç”¨äºæ‰¿æ¥æ¯æ¬¡ llm æ‰§è¡Œä¹‹å‰çš„æ¶ˆæ¯åˆ—è¡¨ï¼Œä¹Ÿå°±æ˜¯ä¸‹æ–¹çš„å®šä¹‰:

```python
class State(TypedDict):
    # å®šä¹‰ä¸€ä¸ªlanggraphä¸­ä¼ è¾“çš„æ¶ˆæ¯åˆ—è¡¨messagesï¼ˆå…ˆåˆ«ç®¡ä¸ºå•¥è¿™ä¹ˆå®šä¹‰ï¼‰
    messages: Annotated[list, add_messages]
```

## å¼•è¨€

é‚£ä¹ˆå¾ˆå¥‡æ€ªå‘¢ï¼Ÿä»€ä¹ˆæ˜¯ **Annotated** ä»€ä¹ˆæ˜¯ **add_messages**ï¼Œæƒ³è¦ææ¸…æ¥šè¿™ä¸¤ä¸ªå«ä¹‰ï¼Œé¦–å…ˆæˆ‘ä»¬å¾—å…ˆæ˜ç¡®ä¸€ä¸ªç‚¹ï¼Œä¹Ÿå°±æ˜¯
æ¯æ¬¡llmæ‰§è¡Œä¹‹å‰ä¼šç»™ä»€ä¹ˆä¸œè¥¿å‘ç»™llmï¼Œå…¶å®ä¸è¨€è€Œå–»çš„å°±æ˜¯æˆ‘ä»¬çš„å¯¹è¯æ¶ˆæ¯åˆ—è¡¨messagesï¼Œä¹Ÿç§°ä¹‹ä¸º chat-history:

1. SystemMessage
2. UserMessage
3. AiMessage
4. ToolMessage

é‚£ä¹ˆå…¶å®ä¸Šé¢å®šä¹‰çš„Stateä¹Ÿå°±æ˜¯è¿™ä¸ªç©æ„å„¿ï¼Œåªæ˜¯å…¶ä¸­ç›®å‰æ ¸å¿ƒå…³æ³¨çš„æ˜¯messagesè€Œå·²ï¼Œå…¶å®è¿˜æœ‰åˆ«çš„ä¾‹å¦‚modelã€tmepture...

æ‰€ä»¥æˆ‘ä»¬ç†è§£äº†è¿™é‡Œå®šä¹‰çš„ç±»å‹ä¸€ä¸ª list[Message]ï¼Œé‚£ä¹ˆä¸ºå•¥æ˜¯  **Annotated** + **add_messages**ï¼Œä¸‹é¢ç»™å‡ºè§£é‡Šï¼š

## 1ã€Annotated

**ä½œç”¨ï¼š**æ ‡è®°çŠ¶æ€å­—æ®µçš„æ›´æ–°è§„åˆ™

**è§£é‡Šï¼š**`Annotated` æ˜¯ Python 3.9+ å¼•å…¥çš„ç±»å‹æ³¨è§£å·¥å…·ï¼ˆæ¥è‡ª `typing` æ¨¡å—ï¼‰ï¼Œè¯­æ³•ä¸º `Annotated[ç±»å‹, å…ƒæ•°æ®]`
ï¼Œä½œç”¨æ˜¯ç»™ã€Œç±»å‹ã€é™„åŠ é¢å¤–çš„å…ƒæ•°æ®ï¼ˆå¯ä»¥æ˜¯å‡½æ•°ã€ç±»ã€å¸¸é‡ç­‰ï¼‰ã€‚

åœ¨ LangGraph ä¸­ï¼Œå®ƒçš„æ ¸å¿ƒç”¨æ³•æ˜¯ï¼š**ç»™çŠ¶æ€å­—æ®µï¼ˆå¦‚ `messages`ï¼‰æ ‡è®°ã€Œæ›´æ–°è¯¥å­—æ®µæ—¶éœ€è¦ä½¿ç”¨çš„å‡½æ•°ã€**ã€‚

## 2ã€add_messages

**ä½œç”¨ï¼š**æ¶ˆæ¯åˆå¹¶çš„å®é™…é€»è¾‘

**è§£é‡Šï¼š**`add_messages` æ˜¯å…·ä½“çš„ã€Œæ›´æ–°è§„åˆ™å‡½æ•°ã€ï¼Œå®ƒå®šä¹‰äº†å¦‚ä½•å°†ã€Œæ–°æ¶ˆæ¯ã€ï¼ˆ`right`ï¼‰åˆå¹¶åˆ°ã€Œå†å²æ¶ˆæ¯ã€ï¼ˆ`left`ï¼‰ä¸­ï¼Œæ ¸å¿ƒé€»è¾‘åŒ…æ‹¬ï¼š

- ç”¨æ¶ˆæ¯ `id` åˆ¤æ–­æ˜¯å¦éœ€è¦æ›¿æ¢ï¼ˆåŒ `id` è¦†ç›–ï¼‰ï¼›
- æ–°å¢æ— é‡å¤ `id` çš„æ¶ˆæ¯ï¼›
- å¤„ç†åˆ é™¤æŒ‡ä»¤ï¼ˆ`RemoveMessage`ï¼‰ï¼›
- å¯é€‰çš„æ ¼å¼è½¬æ¢ï¼ˆå¦‚ `langchain-openai` æ ¼å¼ï¼‰ã€‚

å®ƒçš„è¾“å…¥æ˜¯ä¸¤ä¸ªæ¶ˆæ¯åˆ—è¡¨ï¼ˆ`left` ä¸ºå½“å‰å†å²ï¼Œ`right` ä¸ºæ–°æ¶ˆæ¯ï¼‰ï¼Œè¾“å‡ºæ˜¯åˆå¹¶åçš„æ–°åˆ—è¡¨ã€‚è¿™ä¸ªå‡½æ•°æœ¬èº«æ˜¯çº¯é€»è¾‘å®ç°ï¼Œä¸ä¾èµ–æ¡†æ¶ï¼Œä½†éœ€è¦ç¬¦åˆæ¡†æ¶å¯¹ã€Œæ›´æ–°å™¨å‡½æ•°ã€çš„å‚æ•°å’Œè¿”å›å€¼è¦æ±‚ï¼ˆå¦‚è¾“å…¥
`left` å’Œ `right`ï¼Œè¿”å›åˆå¹¶ç»“æœï¼‰ã€‚

## 3ã€@_add_messages_wrapper

**ä½œç”¨ï¼š**é€‚é…æ¡†æ¶æ¥å£çš„è£…é¥°å™¨

**è§£é‡Šï¼š**è£…é¥°å™¨ `@_add_messages_wrapper` çš„ä½œç”¨æ˜¯ã€ŒåŒ…è£… `add_messages` å‡½æ•°ã€ï¼Œä½¿å…¶èƒ½è¢« LangGraph æ¡†æ¶æ­£ç¡®è¯†åˆ«å’Œè°ƒç”¨ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒè§£å†³äº†ä¸¤ä¸ªé—®é¢˜ï¼š

- **ç»Ÿä¸€æ¥å£è§„èŒƒ**ï¼šLangGraph å¯¹ã€ŒçŠ¶æ€æ›´æ–°å™¨å‡½æ•°ã€æœ‰å›ºå®šçš„æ¥å£è¦æ±‚ï¼ˆæ¯”å¦‚è¾“å…¥å‚æ•°çš„æ ¼å¼ã€è¿”å›å€¼çš„ç±»å‹ï¼‰ã€‚`add_messages`
  æ˜¯ä¸šåŠ¡é€»è¾‘å‡½æ•°ï¼Œè£…é¥°å™¨ä¼šå°†å…¶è½¬æ¢ä¸ºç¬¦åˆæ¡†æ¶è§„èŒƒçš„å‡½æ•°ï¼ˆä¾‹å¦‚å¤„ç†å‚æ•°æ ¡éªŒã€æ ¼å¼é€‚é…ï¼‰ã€‚
- **ç»‘å®šæ›´æ–°é€»è¾‘**ï¼šè£…é¥°å™¨ä¼šç»™ `add_messages` é™„åŠ ä¸€äº›æ¡†æ¶å†…éƒ¨çš„æ ‡è¯†ï¼ˆå¦‚æ ‡è®°è¿™æ˜¯ä¸€ä¸ªã€Œæ¶ˆæ¯æ›´æ–°å™¨ã€ï¼‰ï¼Œè®©æ¡†æ¶åœ¨è¯»å– `Annotated`
  å…ƒæ•°æ®æ—¶ï¼Œèƒ½æ­£ç¡®è¯†åˆ«è¿™æ˜¯ä¸€ä¸ªåˆæ³•çš„æ›´æ–°å™¨å‡½æ•°ã€‚

ç®€å•è¯´ï¼Œè£…é¥°å™¨æ˜¯ `add_messages` å’Œ LangGraph æ¡†æ¶ä¹‹é—´çš„ã€Œç¿»è¯‘å®˜ã€ï¼Œç¡®ä¿æ¡†æ¶èƒ½æ­£ç¡®è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚

## 4ã€ä¸‰è€…è”åŠ¨çš„å®Œæ•´æµç¨‹

å½“åœ¨ LangGraph ä¸­å®šä¹‰å·¥ä½œæµï¼ˆ`StateGraph`ï¼‰å¹¶è¿è¡Œæ—¶ï¼Œè¿™ä¸‰è€…ä¼šæŒ‰ä»¥ä¸‹æ­¥éª¤è‡ªåŠ¨ç»´æŠ¤å¯¹è¯å†å² `messages`ï¼š

### 4.1ã€å®šä¹‰çŠ¶æ€ç»“æ„ï¼Œé€šè¿‡ `Annotated` ç»‘å®šæ›´æ–°è§„åˆ™

```python
class State(TypedDict):
    messages: Annotated[list, add_messages]  # å‘Šè¯‰æ¡†æ¶ï¼šmessages ç”¨ add_messages æ›´æ–°
```

æ­¤æ—¶ï¼Œæ¡†æ¶å·²ç»çŸ¥é“ï¼š`State` ä¸­çš„ `messages` å­—æ®µéœ€è¦ç”¨ `add_messages` å‡½æ•°æ¥æ›´æ–°ã€‚

### 4.2ã€èŠ‚ç‚¹è¿”å›æ–°æ¶ˆæ¯ï¼Œè§¦å‘çŠ¶æ€æ›´æ–°

åœ¨å·¥ä½œæµä¸­ï¼ŒèŠ‚ç‚¹å‡½æ•°ï¼ˆå¦‚å¯¹è¯æœºå™¨äººçš„å›å¤é€»è¾‘ï¼‰ä¼šè¿”å›æ–°çš„æ¶ˆæ¯ï¼Œæ ¼å¼é€šå¸¸æ˜¯ `{"messages": [æ–°æ¶ˆæ¯åˆ—è¡¨]}`ã€‚ä¾‹å¦‚ï¼š

```python
def chatbot_node(state: State) -> dict:
    # ç”Ÿæˆä¸€æ¡æ–°çš„ AI æ¶ˆæ¯
    return {"messages": [AIMessage(content="ä½ å¥½ï¼", id="ai_1")]}
```

å½“èŠ‚ç‚¹è¿è¡Œç»“æŸåï¼Œæ¡†æ¶éœ€è¦å°†è¿™äº›æ–°æ¶ˆæ¯åˆå¹¶åˆ°å½“å‰çŠ¶æ€çš„ `messages` ä¸­ã€‚

### 4.3ã€æ¡†æ¶è‡ªåŠ¨è°ƒç”¨ `add_messages` å®Œæˆåˆå¹¶

æ¡†æ¶ä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

1. æå–å½“å‰çŠ¶æ€ä¸­çš„ `messages` ä½œä¸º `left`ï¼ˆå†å²æ¶ˆæ¯ï¼‰ï¼›
2. æå–èŠ‚ç‚¹è¿”å›çš„ `messages` ä½œä¸º `right`ï¼ˆæ–°æ¶ˆæ¯ï¼‰ï¼›
3. å› ä¸º `messages` å­—æ®µè¢« `Annotated` æ ‡è®°äº† `add_messages`ï¼Œæ¡†æ¶ä¼šè°ƒç”¨è¢« `@_add_messages_wrapper` è£…é¥°åçš„
   `add_messages` å‡½æ•°ï¼Œä¼ å…¥ `left` å’Œ `right`ï¼›
4. ç”¨ `add_messages` çš„è¿”å›å€¼ï¼ˆåˆå¹¶åçš„æ¶ˆæ¯åˆ—è¡¨ï¼‰æ›´æ–°çŠ¶æ€ä¸­çš„ `messages` å­—æ®µã€‚

### 4.4ã€å¤šè½®è¿­ä»£ï¼Œè‡ªåŠ¨ç»´æŠ¤å†å²

åœ¨å¤šè½®å¯¹è¯ä¸­ï¼Œæ¯æ¬¡èŠ‚ç‚¹è¿è¡Œéƒ½ä¼šé‡å¤æ­¥éª¤ 2-3ï¼š

- æ–°æ¶ˆæ¯ä¸æ–­é€šè¿‡ `add_messages` åˆå¹¶åˆ°å†å²ä¸­ï¼›
- è‹¥æœ‰é‡å¤ `id` çš„æ¶ˆæ¯ï¼Œè‡ªåŠ¨æ›¿æ¢ï¼›
- è‹¥æœ‰åˆ é™¤æŒ‡ä»¤ï¼Œè‡ªåŠ¨ç§»é™¤å¯¹åº”æ¶ˆæ¯ã€‚

æœ€ç»ˆå®ç°ã€Œæ— éœ€æ‰‹åŠ¨å¤„ç†åˆå¹¶é€»è¾‘ï¼Œå¯¹è¯å†å²è‡ªåŠ¨ç»´æŠ¤ã€çš„æ•ˆæœã€‚

**ä¸¾ä¾‹ï¼šä¸€æ¬¡å®Œæ•´çš„è”åŠ¨è¿‡ç¨‹**

å‡è®¾åˆå§‹çŠ¶æ€ `state = {"messages": [HumanMessage(content="Hi", id="h1")]}`ï¼ŒèŠ‚ç‚¹è¿”å›
`{"messages": [AIMessage(content="Hello", id="a1")]}`ï¼š

1. æ¡†æ¶è¯»å– `State` å®šä¹‰ï¼Œå‘ç° `messages` ç»‘å®šäº† `add_messages`ï¼›
2. æå– `left = [HumanMessage(id="h1")]`ï¼ˆå½“å‰å†å²ï¼‰ï¼Œ`right = [AIMessage(id="a1")]`ï¼ˆæ–°æ¶ˆæ¯ï¼‰ï¼›
3. è°ƒç”¨ `add_messages(left, right)`ï¼Œè¿”å›åˆå¹¶ç»“æœ `[HumanMessage(id="h1"), AIMessage(id="a1")]`ï¼›
4. æ›´æ–°çŠ¶æ€ `state["messages"]` ä¸ºåˆå¹¶ç»“æœï¼Œå®Œæˆä¸€æ¬¡æ›´æ–°ã€‚

å¦‚æœä¸‹ä¸€è½®èŠ‚ç‚¹è¿”å› `{"messages": [HumanMessage(content="Hi again", id="h1")]}`ï¼ˆåŒ `id` æ›¿æ¢ï¼‰ï¼š

- `left` æ˜¯ä¸Šä¸€è½®çš„ `[h1, a1]`ï¼Œ`right` æ˜¯ `[h1_new]`ï¼›
- `add_messages` ä¼šç”¨ `h1_new` æ›¿æ¢ `h1`ï¼Œç»“æœä¸º `[h1_new, a1]`ï¼›
- çŠ¶æ€è‡ªåŠ¨æ›´æ–°ä¸ºæ–°åˆ—è¡¨ã€‚

### 4.5ã€æ€»ç»“

ä¸‰è€…çš„è”åŠ¨æ ¸å¿ƒæ˜¯ï¼š

- `Annotated` æ ‡è®°ã€Œå“ªä¸ªå‡½æ•°è´Ÿè´£æ›´æ–°å­—æ®µã€ï¼›
- `@_add_messages_wrapper` ç¡®ä¿ã€Œè¿™ä¸ªå‡½æ•°èƒ½è¢«æ¡†æ¶è°ƒç”¨ã€ï¼›
- `add_messages` å®ç°ã€Œå…·ä½“çš„æ›´æ–°é€»è¾‘ã€ã€‚

æœ€ç»ˆï¼ŒLangGraph æ¡†æ¶é€šè¿‡è¯»å– `Annotated` å…ƒæ•°æ®ï¼Œè‡ªåŠ¨è°ƒç”¨è£…é¥°åçš„ `add_messages` å‡½æ•°ï¼Œåœ¨æ¯æ¬¡èŠ‚ç‚¹è¿è¡Œåå®Œæˆæ¶ˆæ¯åˆå¹¶ï¼Œä»è€Œå®ç°å¯¹è¯å†å²çš„è‡ªåŠ¨ç»´æŠ¤ã€‚

ä¸Šé¢è¿˜æ˜¯å¾ˆå¤æ‚çš„åŸç†ï¼Œå…¶å®æœ‰ä¸€ä¸ªæ ¸å¿ƒçš„æ¦‚å¿µå°±æ˜¯ï¼š

> LangGraph çŠ¶æ€ç®¡ç†æœºåˆ¶ï¼šé€šè¿‡ç±»å‹æ³¨è§£æ ‡è®°çŠ¶æ€å­—æ®µçš„æ›´æ–°è§„åˆ™ï¼Œé€šè¿‡è£…é¥°å™¨é€‚é…è§„åˆ™å‡½æ•°ï¼Œæœ€ç»ˆè®©æ¡†æ¶è‡ªåŠ¨è°ƒç”¨è§„åˆ™å‡½æ•°å®ŒæˆçŠ¶æ€æ›´æ–°ã€‚

å…¶å®å¦‚æœä¸è¿›è¡Œç†è§£ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œç›´æ¥ä½¿ç”¨å³å¯ï¼Œä»…ä»…æ˜¯langgraphå°è£…çš„å¾ˆå¤æ‚è€Œå·²ï¼Œç®€å•ç†è§£å°±æ˜¯ç®€å•çš„ä¸œè¥¿ä»–ä»¬ç»è¿‡å·¥ç¨‹åŒ–ä¹‹åè¿‡äºå¤æ‚äº†ï¼Œåè€Œä¸åˆ©äºå¼€å‘è€…è¯»æ‡‚

ï¼ˆ`è¿™å°±æ˜¯ä¼ è¯´ä¸­çš„ç‚«æŠ€ï¼Œæˆ‘æƒ³è¾¾åˆ°çš„æ°´å¹³ï¼Œå¯æƒœå¥ˆä½•å®åŠ›ä¸å¤ŸğŸ˜€`ï¼‰







------







ä¸‹é¢å°†ç»™å‡ºä¸€ä¸ªå®Œæ•´çš„è¯¦ç»†è§£é‡Šï¼Œæ¥è‡ªäºgptçš„å†…å®¹ï¼Œçœ‹çœ‹å°±å¥½

## 5ã€è¯¦ç»†è§£é‡Š

è¿™æ®µä»£ç æ˜¯ LangChainï¼ˆå°¤å…¶æ˜¯ LangGraph æ¡†æ¶ï¼‰ä¸­ç”¨äº**ç®¡ç†æ¶ˆæ¯åˆ—è¡¨åˆå¹¶ä¸æ›´æ–°**çš„æ ¸å¿ƒå·¥å…·ï¼Œä¸»è¦åŠŸèƒ½æ˜¯åˆå¹¶ä¸¤ä¸ªæ¶ˆæ¯åˆ—è¡¨ï¼ˆ`left`å’Œ
`right`ï¼‰ï¼Œå¹¶æ ¹æ®æ¶ˆæ¯ ID å¤„ç† â€œæ–°å¢â€â€œæ›¿æ¢â€â€œåˆ é™¤â€ é€»è¾‘ã€‚å®ƒåœ¨å¤šè½®å¯¹è¯ã€çŠ¶æ€ç®¡ç†åœºæ™¯ä¸­éå¸¸é‡è¦ï¼Œä¸‹é¢ä»åŠŸèƒ½ã€ç»†èŠ‚ã€ä½¿ç”¨æ¡ˆä¾‹å’Œç»“æœå±•å¼€è¯´æ˜ã€‚

### 5.1ã€æ ¸å¿ƒåŠŸèƒ½ï¼šæ¶ˆæ¯åˆ—è¡¨çš„æ™ºèƒ½åˆå¹¶

`add_messages` å‡½æ•°çš„æ ¸å¿ƒä½œç”¨æ˜¯ï¼šå°†ä¸¤ä¸ªæ¶ˆæ¯åˆ—è¡¨ï¼ˆ`left` ä½œä¸ºåŸºç¡€åˆ—è¡¨ï¼Œ`right` ä½œä¸ºå¾…åˆå¹¶åˆ—è¡¨ï¼‰åˆå¹¶ä¸ºä¸€ä¸ªæ–°åˆ—è¡¨ï¼Œéµå¾ªä»¥ä¸‹è§„åˆ™ï¼š

- **æ–°å¢**ï¼šå¦‚æœ `right` ä¸­çš„æ¶ˆæ¯ ID åœ¨ `left` ä¸­ä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿½åŠ åˆ°åˆå¹¶ç»“æœä¸­ã€‚
- **æ›¿æ¢**ï¼šå¦‚æœ `right` ä¸­çš„æ¶ˆæ¯ ID ä¸ `left` ä¸­æŸä¸ªæ¶ˆæ¯çš„ ID ç›¸åŒï¼Œåˆ™ç”¨ `right` çš„æ¶ˆæ¯æ›¿æ¢ `left` çš„æ¶ˆæ¯ã€‚
- **åˆ é™¤**ï¼šå¦‚æœ `right` ä¸­åŒ…å« `RemoveMessage` ç±»å‹çš„æ¶ˆæ¯ï¼ˆä¸” ID å­˜åœ¨äº `left` ä¸­ï¼‰ï¼Œåˆ™ä»åˆå¹¶ç»“æœä¸­åˆ é™¤è¯¥ ID å¯¹åº”çš„æ¶ˆæ¯ï¼›è‹¥
  `RemoveMessage` çš„ ID ä¸º `REMOVE_ALL_MESSAGES`ï¼Œåˆ™æ¸…ç©ºä¹‹å‰çš„æ‰€æœ‰æ¶ˆæ¯ï¼Œåªä¿ç•™ `right` ä¸­è¯¥æ¶ˆæ¯ä¹‹åçš„å†…å®¹ã€‚
- **æ ¼å¼è½¬æ¢**ï¼šæ”¯æŒå°†åˆå¹¶åçš„æ¶ˆæ¯è½¬æ¢ä¸º `langchain-openai` æ ¼å¼ï¼ˆé€‚é… OpenAI çš„æ¶ˆæ¯ç»“æ„ï¼Œå¦‚æ–‡æœ¬ã€å›¾ç‰‡å—ç­‰ï¼‰ã€‚

### 5.2ã€ä»£ç ç»†èŠ‚è§£æ

#### 1. å‡½æ•°å‚æ•°

- `left: Messages`ï¼šåŸºç¡€æ¶ˆæ¯åˆ—è¡¨ï¼ˆé€šå¸¸æ˜¯å·²æœ‰çš„å†å²æ¶ˆæ¯ï¼‰ã€‚
- `right: Messages`ï¼šå¾…åˆå¹¶çš„æ¶ˆæ¯åˆ—è¡¨ï¼ˆé€šå¸¸æ˜¯æ–°ç”Ÿæˆçš„æ¶ˆæ¯ï¼‰ã€‚
- `format: Literal["langchain-openai"] | None`ï¼šå¯é€‰å‚æ•°ï¼ŒæŒ‡å®šè¾“å‡ºæ¶ˆæ¯çš„æ ¼å¼ã€‚`None` è¡¨ç¤ºä¿æŒåŸå§‹æ ¼å¼ï¼›`"langchain-openai"`
  è¡¨ç¤ºè½¬æ¢ä¸ºç¬¦åˆ OpenAI è§„èŒƒçš„æ¶ˆæ¯ç»“æ„ï¼ˆå¦‚æ”¯æŒæ–‡æœ¬å—ã€å›¾ç‰‡ URL å—ç­‰ï¼‰ã€‚

#### 2. å†…éƒ¨é€»è¾‘æ‹†è§£

##### ï¼ˆ1ï¼‰ç±»å‹ç»Ÿä¸€ä¸æ¶ˆæ¯è½¬æ¢

```python
# ç¡®ä¿leftå’Œrightæ˜¯åˆ—è¡¨ï¼ˆå¦‚æœä¼ å…¥å•ä¸ªæ¶ˆæ¯åˆ™è½¬ä¸ºåˆ—è¡¨ï¼‰
if not isinstance(left, list):
    left = [left]
if not isinstance(right, list):
    right = [right]

# å°†è¾“å…¥çš„æ¶ˆæ¯è½¬æ¢ä¸ºæ ‡å‡†BaseMessageå¯¹è±¡ï¼ˆå¤„ç†ä¸åŒæ ¼å¼çš„æ¶ˆæ¯è¾“å…¥ï¼‰
left = [message_chunk_to_message(cast(BaseMessageChunk, m)) for m in convert_to_messages(left)]
right = [message_chunk_to_message(cast(BaseMessageChunk, m)) for m in convert_to_messages(right)]
```

è¿™ä¸€æ­¥ç¡®ä¿è¾“å…¥çš„æ¶ˆæ¯ï¼ˆæ— è®ºåŸå§‹æ ¼å¼å¦‚ä½•ï¼Œå¦‚å­—å…¸ã€å­—ç¬¦ä¸²ã€Message å¯¹è±¡ï¼‰éƒ½è¢«è½¬æ¢ä¸º LangChain æ ‡å‡†çš„ `BaseMessage` ç±»å‹ï¼ˆå¦‚
`HumanMessage`ã€`AIMessage` ç­‰ï¼‰ï¼Œç»Ÿä¸€å¤„ç†æ ¼å¼ã€‚

##### ï¼ˆ2ï¼‰æ¶ˆæ¯ ID å¤„ç†

```python
# ä¸ºæ²¡æœ‰IDçš„æ¶ˆæ¯è‡ªåŠ¨ç”ŸæˆUUIDï¼ˆç¡®ä¿æ¯ä¸ªæ¶ˆæ¯æœ‰å”¯ä¸€æ ‡è¯†ï¼‰
for m in left:
    if m.id is None:
        m.id = str(uuid.uuid4())
for idx, m in enumerate(right):
    if m.id is None:
        m.id = str(uuid.uuid4())
    # æ£€æŸ¥æ˜¯å¦æœ‰"åˆ é™¤æ‰€æœ‰æ¶ˆæ¯"çš„æ ‡è®°
    if isinstance(m, RemoveMessage) and m.id == REMOVE_ALL_MESSAGES:
        remove_all_idx = idx
```

æ¯ä¸ªæ¶ˆæ¯å¿…é¡»æœ‰å”¯ä¸€ IDï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦æ›¿æ¢ / åˆ é™¤ï¼‰ï¼Œå¦‚æœç”¨æˆ·æœªæŒ‡å®šï¼Œè‡ªåŠ¨ç”Ÿæˆ UUIDã€‚åŒæ—¶æ£€æµ‹ `right` ä¸­æ˜¯å¦æœ‰ â€œåˆ é™¤æ‰€æœ‰æ¶ˆæ¯â€
çš„æŒ‡ä»¤ï¼ˆ`RemoveMessage` ä¸” ID ä¸º `REMOVE_ALL_MESSAGES`ï¼‰ã€‚

##### ï¼ˆ3ï¼‰åˆå¹¶é€»è¾‘

- **å¤„ç† â€œåˆ é™¤æ‰€æœ‰æ¶ˆæ¯â€**ï¼šå¦‚æœ `right` ä¸­å­˜åœ¨ `REMOVE_ALL_MESSAGES`ï¼Œåˆ™åˆå¹¶ç»“æœä»…ä¿ç•™ `right` ä¸­è¯¥æ¶ˆæ¯ä¹‹åçš„å†…å®¹ï¼ˆæ¸…ç©ºå†å²æ¶ˆæ¯ï¼‰ã€‚

  ```python
  if remove_all_idx is not None:
      return right[remove_all_idx + 1 :]
  ```

- **å¸¸è§„åˆå¹¶ï¼ˆæ›¿æ¢ / æ–°å¢ / åˆ é™¤ï¼‰**ï¼š

  ```python
  merged = left.copy()  # ä»¥leftä¸ºåŸºç¡€
  merged_by_id = {m.id: i for i, m in enumerate(merged)}  # ç”¨å­—å…¸è®°å½•leftä¸­æ¶ˆæ¯IDä¸ç´¢å¼•çš„æ˜ å°„
  ids_to_remove = set()  # è®°å½•éœ€è¦åˆ é™¤çš„æ¶ˆæ¯ID
  
  for m in right:
      if m.id in merged_by_id:  # è‹¥rightçš„æ¶ˆæ¯IDåœ¨leftä¸­å­˜åœ¨
          if isinstance(m, RemoveMessage):  # å¦‚æœæ˜¯åˆ é™¤æŒ‡ä»¤ï¼Œæ ‡è®°å¾…åˆ é™¤
              ids_to_remove.add(m.id)
          else:  # å¦åˆ™æ›¿æ¢leftä¸­çš„æ¶ˆæ¯
              merged[merged_by_id[m.id]] = m
      else:  # è‹¥IDä¸å­˜åœ¨
          if isinstance(m, RemoveMessage):  # ä¸èƒ½åˆ é™¤ä¸å­˜åœ¨çš„æ¶ˆæ¯ï¼ŒæŠ›é”™
              raise ValueError(f"Attempting to delete a message with an ID that doesn't exist ('{m.id}')")
          # æ–°å¢æ¶ˆæ¯åˆ°åˆå¹¶åˆ—è¡¨
          merged.append(m)
          merged_by_id[m.id] = len(merged) - 1
  
  # æœ€ç»ˆç§»é™¤æ‰€æœ‰æ ‡è®°ä¸ºåˆ é™¤çš„æ¶ˆæ¯
  merged = [m for m in merged if m.id not in ids_to_remove]
  ```

##### ï¼ˆ4ï¼‰æ ¼å¼è½¬æ¢

å¦‚æœæŒ‡å®š `format="langchain-openai"`ï¼Œåˆ™è°ƒç”¨ `_format_messages` å°†æ¶ˆæ¯è½¬æ¢ä¸º OpenAI å…¼å®¹çš„æ ¼å¼ï¼ˆä¾‹å¦‚ï¼Œå›¾ç‰‡æ¶ˆæ¯ä¼šè½¬ä¸º
`image_url` ç»“æ„ï¼‰ï¼š

```python
if format == "langchain-openai":
    merged = _format_messages(merged)
```

#### 3. è£…é¥°å™¨ `@_add_messages_wrapper`

è¿™æ˜¯ LangGraph æ¡†æ¶çš„å†…éƒ¨è£…é¥°å™¨ï¼Œä¸»è¦ä½œç”¨æ˜¯å°† `add_messages` å‡½æ•°æ ‡è®°ä¸º â€œçŠ¶æ€æ›´æ–°å™¨â€ï¼Œä½¿å…¶èƒ½åœ¨ LangGraph
çš„çŠ¶æ€ç®¡ç†ä¸­è¢«è‡ªåŠ¨è°ƒç”¨ï¼ˆä¾‹å¦‚ï¼Œå½“å®šä¹‰çŠ¶æ€ä¸­çš„ `messages` å­—æ®µæ—¶ï¼Œé€šè¿‡ `Annotated` å…³è”è¯¥å‡½æ•°ï¼Œå®ç°æ¶ˆæ¯çš„è‡ªåŠ¨åˆå¹¶ï¼‰ã€‚

### 5.3ã€`State` ç±»çš„ä½œç”¨

```python
class State(TypedDict):
    messages: Annotated[list, add_messages]
```

è¿™æ˜¯ LangGraph ä¸­å®šä¹‰ â€œçŠ¶æ€ç»“æ„â€ çš„å…¸å‹æ–¹å¼ï¼š

- `State` ç»§æ‰¿ `TypedDict`ï¼Œç”¨äºå®šä¹‰å¤šæ™ºèƒ½ä½“ / å·¥ä½œæµä¸­ä¼ é€’çš„çŠ¶æ€æ•°æ®ç»“æ„ï¼ˆç±»ä¼¼å­—å…¸çš„é”®å€¼å¯¹ï¼‰ã€‚
- `messages` æ˜¯çŠ¶æ€ä¸­çš„ä¸€ä¸ªå­—æ®µï¼Œå­˜å‚¨å¯¹è¯æ¶ˆæ¯åˆ—è¡¨ã€‚
- `Annotated[list, add_messages]` è¡¨ç¤ºï¼šå½“æ›´æ–° `messages` å­—æ®µæ—¶ï¼Œè‡ªåŠ¨ä½¿ç”¨ `add_messages` å‡½æ•°è¿›è¡Œåˆå¹¶ï¼ˆè€Œä¸æ˜¯ç®€å•è¦†ç›–ï¼‰ã€‚è¿™æ˜¯
  LangGraph çš„æ ¸å¿ƒç‰¹æ€§ï¼Œç¡®ä¿å¤šè½®å¯¹è¯ä¸­æ¶ˆæ¯åˆ—è¡¨èƒ½ â€œæ™ºèƒ½æ›´æ–°â€ï¼ˆä¿ç•™å†å²ã€å¤„ç†æ›¿æ¢ / åˆ é™¤ï¼‰ã€‚

### 5.4ã€ä½¿ç”¨æ¡ˆä¾‹ä¸ç»“æœå±•ç¤º

#### æ¡ˆä¾‹ 1ï¼šåŸºç¡€åˆå¹¶ï¼ˆæ–°å¢æ¶ˆæ¯ï¼‰

```python
from langchain_core.messages import AIMessage, HumanMessage

# åŸºç¡€æ¶ˆæ¯åˆ—è¡¨ï¼ˆleftï¼‰
msgs1 = [HumanMessage(content="Hello", id="1")]
# å¾…åˆå¹¶æ¶ˆæ¯åˆ—è¡¨ï¼ˆrightï¼‰
msgs2 = [AIMessage(content="Hi there!", id="2")]

# åˆå¹¶
result = add_messages(msgs1, msgs2)
print(result)
```

**ç»“æœ**ï¼šä¸¤ä¸ªæ¶ˆæ¯åˆ—è¡¨åˆå¹¶ï¼Œ`right` ä¸­çš„æ–°æ¶ˆæ¯è¢«è¿½åŠ ï¼š

```plaintext
[HumanMessage(content='Hello', id='1'), AIMessage(content='Hi there!', id='2')]
```

#### æ¡ˆä¾‹ 2ï¼šæ›¿æ¢å·²æœ‰æ¶ˆæ¯ï¼ˆåŒ ID è¦†ç›–ï¼‰

```python
# åŸºç¡€æ¶ˆæ¯åˆ—è¡¨ï¼ˆleftï¼‰
msgs1 = [HumanMessage(content="Hello", id="1")]
# å¾…åˆå¹¶æ¶ˆæ¯åˆ—è¡¨ï¼ˆrightï¼‰ï¼šåŒIDä½†å†…å®¹ä¸åŒ
msgs2 = [HumanMessage(content="Hello again", id="1")]

# åˆå¹¶
result = add_messages(msgs1, msgs2)
print(result)
```

**ç»“æœ**ï¼š`right` ä¸­åŒ ID çš„æ¶ˆæ¯æ›¿æ¢äº† `left` ä¸­çš„æ¶ˆæ¯ï¼š

```plaintext
[HumanMessage(content='Hello again', id='1')]
```

#### æ¡ˆä¾‹ 3ï¼šåœ¨ LangGraph ä¸­ç®¡ç†å¯¹è¯çŠ¶æ€

```python
from typing import Annotated
from typing_extensions import TypedDict
from langgraph.graph import StateGraph


# å®šä¹‰çŠ¶æ€ç»“æ„ï¼šmessageså­—æ®µç”¨add_messagesè‡ªåŠ¨åˆå¹¶
class State(TypedDict):
    messages: Annotated[list, add_messages]


# å®šä¹‰èŠ‚ç‚¹å‡½æ•°ï¼šç”Ÿæˆä¸€æ¡AIæ¶ˆæ¯
def chatbot(state: State) -> dict:
    return {"messages": [AIMessage(content="Hello, I'm a bot!", id="ai_1")]}


# æ„å»ºå·¥ä½œæµ
builder = StateGraph(State)
builder.add_node("chatbot", chatbot)  # æ·»åŠ èŠ‚ç‚¹
builder.set_entry_point("chatbot")  # å…¥å£èŠ‚ç‚¹
builder.set_finish_point("chatbot")  # ç»“æŸèŠ‚ç‚¹
graph = builder.compile()

# è¿è¡Œå·¥ä½œæµï¼ˆåˆå§‹çŠ¶æ€ä¸ºç©ºï¼‰
result = graph.invoke({})
print(result["messages"])
```

**ç»“æœ**ï¼šçŠ¶æ€ä¸­çš„ `messages` å­—æ®µé€šè¿‡ `add_messages` è‡ªåŠ¨æ›´æ–°ï¼ŒåŒ…å«ç”Ÿæˆçš„ AI æ¶ˆæ¯ï¼š

```plaintext
[AIMessage(content="Hello, I'm a bot!", id="ai_1")]
```

#### æ¡ˆä¾‹ 4ï¼šåˆ é™¤æ¶ˆæ¯ä¸æ ¼å¼è½¬æ¢

```python
from langchain_core.messages import RemoveMessage

# åŸºç¡€æ¶ˆæ¯åˆ—è¡¨
left = [
    HumanMessage(content="First message", id="1"),
    AIMessage(content="First reply", id="2")
]

# å¾…åˆå¹¶åˆ—è¡¨ï¼šå…ˆåˆ é™¤ID=1çš„æ¶ˆæ¯ï¼Œå†æ–°å¢ä¸€æ¡æ¶ˆæ¯
right = [
    RemoveMessage(id="1"),  # åˆ é™¤ID=1çš„æ¶ˆæ¯
    HumanMessage(content="New message", id="3")  # æ–°å¢æ¶ˆæ¯
]

# åˆå¹¶ï¼ˆä¸æŒ‡å®šæ ¼å¼ï¼‰
result = add_messages(left, right)
print("åˆå¹¶åï¼ˆåŸå§‹æ ¼å¼ï¼‰ï¼š", result)

# åˆå¹¶ï¼ˆæŒ‡å®šOpenAIæ ¼å¼ï¼‰
result_openai = add_messages(left, right, format="langchain-openai")
print("åˆå¹¶åï¼ˆOpenAIæ ¼å¼ï¼‰ï¼š", result_openai)
```

**ç»“æœ**ï¼š

- åŸå§‹æ ¼å¼ï¼šID=1 çš„æ¶ˆæ¯è¢«åˆ é™¤ï¼Œæ–°å¢ ID=3 çš„æ¶ˆæ¯ã€‚
- OpenAI æ ¼å¼ï¼šæ¶ˆæ¯å†…å®¹è¢«è½¬æ¢ä¸ºç¬¦åˆ OpenAI è§„èŒƒçš„ç»“æ„ï¼ˆå¦‚æ–‡æœ¬å—ï¼‰ã€‚

```plaintext
åˆå¹¶åï¼ˆåŸå§‹æ ¼å¼ï¼‰ï¼š[AIMessage(content='First reply', id='2'), HumanMessage(content='New message', id='3')]
åˆå¹¶åï¼ˆOpenAIæ ¼å¼ï¼‰ï¼š[AIMessage(content='First reply', id='2'), HumanMessage(content='New message', id='3')]  # ç¤ºä¾‹ï¼Œå®é™…ä¼šè½¬æ¢ä¸ºOpenAIçš„æ¶ˆæ¯ç»“æ„
```

### 5.5ã€æ€»ç»“

`add_messages` æ˜¯ LangChain ä¸­ç®¡ç†æ¶ˆæ¯åˆ—è¡¨çš„æ ¸å¿ƒå·¥å…·ï¼Œé€šè¿‡ â€œID åŒ¹é…â€ å®ç°æ¶ˆæ¯çš„æ–°å¢ã€æ›¿æ¢å’Œåˆ é™¤ï¼Œç¡®ä¿å¤šè½®å¯¹è¯çŠ¶æ€çš„ä¸€è‡´æ€§ã€‚ç»“åˆ
LangGraph çš„ `State` ç±»ï¼ˆç”¨ `Annotated` å…³è”ï¼‰ï¼Œå¯ä»¥åœ¨å·¥ä½œæµ / å¤šæ™ºèƒ½ä½“ç³»ç»Ÿä¸­è‡ªåŠ¨ç»´æŠ¤æ¶ˆæ¯çŠ¶æ€ï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†åˆå¹¶é€»è¾‘ã€‚

å…¶å…¸å‹åº”ç”¨åœºæ™¯åŒ…æ‹¬ï¼šå¤šè½®å¯¹è¯æœºå™¨äººã€æ™ºèƒ½ä½“ä¹‹é—´çš„æ¶ˆæ¯ä¼ é€’ã€å¸¦å†å²è®°å½•çš„äº¤äº’ç³»ç»Ÿç­‰ï¼Œå°¤å…¶é€‚åˆéœ€è¦ â€œå¢é‡æ›´æ–°â€ æ¶ˆæ¯åˆ—è¡¨çš„åœºæ™¯ã€‚